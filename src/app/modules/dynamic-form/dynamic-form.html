<form
  nz-form
  [formGroup]="form"
  [nzLayout]="layout"
  [style.max-width.px]="maxWidth"
  class="df-container">

  <!-- ===== Mode STEPS si présent ===== -->
  <ng-container *ngIf="visibleSteps.length; else rootMode">
    <nz-steps [nzCurrent]="current()" class="df-steps" (nzIndexChange)="onStepHeaderIndexChange($event)" (click)="onStepperClick()">
      <nz-step *ngFor="let s of visibleSteps" [nzTitle]="s.title || 'Étape'"></nz-step>
      <nz-step *ngIf="summaryEnabled" [nzTitle]="summaryTitle"></nz-step>
    </nz-steps>

    <ng-container *ngFor="let s of visibleSteps; let i = index">
      <ng-container *ngIf="current() === i">
        <!-- Fields of step (sections or single fields) -->
        <ng-container *ngFor="let f of (s.fields || []); let k = index">
          <!-- Section field in step -->
          <ng-container *ngIf="f.type==='section'; else stepSingleField">
            <div class="df-edit-section-wrap" [class.df-edit]="editMode" [class.df-edit-selected]="selectedSection === f" (click)="onSelectSection(i, k, $any(f), $event)">
              <df-section [section]="$any(f)" [form]="form" [ui]="ui"
                          [editMode]="editMode" [selectedField]="selectedField"
                          [allowMove]="editAllowMove" [allowDelete]="editAllowDelete"
                          (moveField)="onMoveInSection($event.index, $event.dir, i, k)"
                          (deleteField)="onDeleteInSection($event.index, i, k)"
                          (selectField)="onSelectInSection($event.index, i, k, (($any(f).fields)||[])[ $event.index ])">
              </df-section>
              <div *ngIf="editMode" style="display:flex; gap:6px; justify-content:flex-end; margin:-8px 0 8px;">
                <button nz-button nzSize="small" (click)="editMoveItem.emit({ path: 'step', stepIndex: i, index: k, dir: 'up' }); $event.stopPropagation()">▲</button>
                <button nz-button nzSize="small" (click)="editMoveItem.emit({ path: 'step', stepIndex: i, index: k, dir: 'down' }); $event.stopPropagation()">▼</button>
                <button nz-button nzSize="small" nzDanger (click)="onDeleteInStepRoot(k, i); $event.stopPropagation()">Supprimer</button>
              </div>
            </div>
          </ng-container>
          <!-- Single field in step -->
          <ng-template #stepSingleField>
            <div class="df-edit-item" [class.df-edit]="editMode" [class.df-edit-selected]="selectedField === f" (click)="onSelectInStepRoot(k, i, $any(f))">
              <df-section [section]="singleFieldSection($any(f))" [form]="form" [ui]="ui" [editMode]="false"></df-section>
              <div *ngIf="editMode" style="display:flex; gap:6px; justify-content:flex-end; margin:-8px 0 8px;">
                <button nz-button nzSize="small" (click)="editMoveItem.emit({ path: 'step', stepIndex: i, index: k, dir: 'up' }); $event.stopPropagation()">▲</button>
                <button nz-button nzSize="small" (click)="editMoveItem.emit({ path: 'step', stepIndex: i, index: k, dir: 'down' }); $event.stopPropagation()">▼</button>
                <button nz-button nzSize="small" nzDanger (click)="onDeleteInStepRoot(k, i); $event.stopPropagation()">Supprimer</button>
              </div>
            </div>
          </ng-template>
        </ng-container>

        <div class="df-actions">
          <button nz-button (click)="prev()" *ngIf="i > 0">Précédent</button>
          <button nz-button nzType="primary" (click)="next()" *ngIf="i < realStepsCount - 1" [disabled]="isNextDisabled(i)">Suivant</button>
          <button nz-button nzType="primary" (click)="go(summaryIndex)" *ngIf="i === realStepsCount - 1 && summaryEnabled" [disabled]="!isCurrentStepValid() || form.pending">Voir le résumé</button>
          <button nz-button nzType="primary" (click)="submit()" *ngIf="i === realStepsCount - 1 && !summaryEnabled" [disabled]="isSubmitDisabled()">Valider</button>
        </div>
      </ng-container>
    </ng-container>

    <!-- Step Résumé -->
    <ng-container *ngIf="summaryEnabled && current() === summaryIndex">
      <h3 class="df-summary-title">{{ summaryTitle }}</h3>
      <ng-container *ngFor="let st of summaryModel">
        <h4 class="df-summary-step">{{ st.title }}</h4>
        <ng-container *ngFor="let sec of st.sections">
          <div *ngIf="sec.title" class="df-summary-section">{{ sec.title }}</div>
          <table class="df-summary-table">
            <tbody>
              <tr *ngFor="let r of sec.rows">
                <td class="k">{{ r.label }}</td>
                <td class="v">{{ r.value }}</td>
              </tr>
            </tbody>
          </table>
        </ng-container>
      </ng-container>
      <div class="df-actions">
        <button nz-button (click)="go(realStepsCount - 1)">Modifier</button>
        <button nz-button nzType="primary" (click)="submit()" [disabled]="isSubmitDisabled()">Valider</button>
      </div>
    </ng-container>
  </ng-container>

  <!-- ===== Mode SANS STEPS (racine) ===== -->
  <ng-template #rootMode>
  <!-- Parcours unique: ordre mixte sections + fields à la racine -->
  <ng-container *ngFor="let it of rootItems(); let i = index">
    <!-- Section -->
    <ng-container *ngIf="it.ent.t==='section'; else rootField">
      <div class="df-edit-section-wrap" [class.df-edit]="editMode" [class.df-edit-selected]="selectedSection === ($any(schema.fields)[it.ent.i])" (click)="onSelectSection(undefined, it.ent.i, ($any(schema.fields)[it.ent.i]), $event)">
        <df-section [section]="$any(($any(schema.fields))[it.ent.i])" [form]="form" [ui]="ui"
                    [editMode]="editMode" [selectedField]="selectedField"
                    [allowMove]="editAllowMove" [allowDelete]="editAllowDelete"
                    (moveField)="onMoveInSection($event.index, $event.dir, undefined, it.ent.i)"
                    (deleteField)="onDeleteInSection($event.index, undefined, it.ent.i)"
                    (selectField)="onSelectInSection($event.index, undefined, it.ent.i, (($any(schema.fields)[it.ent.i]).fields || [])[ $event.index ])">
        </df-section>
        <div *ngIf="editMode" style="display:flex; gap:6px; justify-content:flex-end; margin:-8px 0 8px;">
          <button nz-button nzSize="small" (click)="editMoveItem.emit({ path: 'root', index: i, dir: 'up' })">▲</button>
          <button nz-button nzSize="small" (click)="editMoveItem.emit({ path: 'root', index: i, dir: 'down' })">▼</button>
          <button nz-button nzSize="small" nzDanger (click)="editDeleteField.emit({ path: 'flat', index: i })">Supprimer</button>
        </div>
      </div>
    </ng-container>

    <!-- Field racine -->
    <ng-template #rootField>
      <div class="df-edit-item" [class.df-edit]="editMode" [class.df-edit-selected]="selectedField === (($any(schema.fields))[it.ent.i])" (click)="onSelectInFlat(i, (($any(schema.fields))[it.ent.i]))">
        <df-section [section]="singleFieldSection(($any(schema.fields))[it.ent.i])" [form]="form" [ui]="ui" [editMode]="false"></df-section>
      </div>
      <div *ngIf="editMode" style="display:flex; gap:6px; justify-content:flex-end; margin:-8px 0 8px;">
        <button nz-button nzSize="small" (click)="editMoveItem.emit({ path: 'root', index: i, dir: 'up' })">▲</button>
        <button nz-button nzSize="small" (click)="editMoveItem.emit({ path: 'root', index: i, dir: 'down' })">▼</button>
        <button nz-button nzSize="small" nzDanger (click)="onDeleteInFlat(i)">Supprimer</button>
      </div>
    </ng-template>
  </ng-container>

  <div class="df-actions">
    <button
      nz-button
      nzType="primary"
      (click)="form.valid ? submit() : form.markAllAsTouched()"
      [disabled]="isSubmitDisabled()">
      Valider
    </button>
  </div>
  </ng-template>
  </form>
