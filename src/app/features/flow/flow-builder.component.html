<div class="flow-builder" cdkDropListGroup>
  <aside class="palette" cdkDropList #sourceList="cdkDropList" [cdkDropListData]="items" [cdkDropListConnectedTo]="[targetList]" [cdkDropListSortingDisabled]="true">
    <h4>Palette</h4>
    <div class="items">
      <div class="item" *ngFor="let it of items" [class.dragging]="isDragging(it)">
        <div class="icon"><i [class]="it.template?.icon"></i></div>
        <div class="meta">
          <div class="title">{{ it.label }}</div>
          <div class="subtitle" *ngIf="it.template?.subtitle">{{ it.template?.subtitle }}</div>
        </div>
        <!-- Drag proxy overlay to keep original item visible while dragging -->
        <div class="drag-proxy" cdkDrag [cdkDragData]="{ label: it.label, template: it.template }"
             (cdkDragStarted)="onDragStart(it, $event)" (cdkDragEnded)="onDragEnd(it, $event)">
          <ng-template cdkDragPreview>
            <div class="item" style="  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:10px;
  padding:10px 12px;
  box-shadow:0 10px 24px rgba(0,0,0,.18);
  display:inline-flex;
  align-items:center;
  gap:10px; width: 233px">
              <div class="icon"><i [class]="it.template?.icon"></i></div>
              <div class="meta">
                <div class="title">{{ it.label }}</div>
                <div class="subtitle" *ngIf="it.template?.subtitle">{{ it.template?.subtitle }}</div>
              </div>
            </div>
          </ng-template>
        </div>
      </div>
    </div>
  </aside>

  <section class="canvas">
    <div class="canvas-host" #flowHost cdkDropList #targetList="cdkDropList" [cdkDropListData]="nodes" [cdkDropListConnectedTo]="[sourceList]"
         (cdkDropListEntered)="onDragEnter($event)"
         (cdkDropListExited)="onDragLeave($event)"
         (dragover)="onDragOver($event)"
         (wheel)="onWheel($event)"
         (cdkDropListDropped)="onExternalDrop($event)">
      <vflow view="auto" background="#EEF0F4" [entitiesSelectable]="true" [minZoom]="0.05" [maxZoom]="3"
             [nodes]="nodes" [edges]="edges" [connection]="connectionSettings"
             (onConnect)="onConnect($event)" (selected)="onSelected($event)"
             (onNodesChange.position.single)="onNodePositionChange($event)"
             (onNodesChange.remove.many)="onNodesRemoved($event)"
             (onEdgesChange.remove)="onEdgesRemoved($event)"
             (onEdgesChange.detached)="onEdgesDetached($event)"
             #flow>
        <ng-template let-ctx edge>
          <svg:g customTemplateEdge>
            <svg:path
              fill="none"
              [attr.d]="ctx.path()"
              [attr.stroke-width]="ctx.edge.data?.error ? 2 : (ctx.edge.data?.strokeWidth || 2)"
              [attr.stroke]="ctx.edge.data?.error ? '#f759ab' : (ctx.edge.data?.color || '#b1b1b7')"
              [attr.marker-end]="ctx.markerEnd()" />
          </svg:g>
        </ng-template>
        <ng-template let-ctx edgeLabelHtml>
          <div class="edge-labels" [ngClass]="{ error: ctx.edge?.data?.error || (getEdgeLabel(ctx.edge) || (ctx.label?.data?.text || '')) === 'Error' }">
            <div class="badge label" *ngIf="(getEdgeLabel(ctx.edge) || (ctx.label?.data?.text || '')) as txt" [ngClass]="{ error: ctx.edge?.data?.error || txt === 'Error' }">{{ txt }}</div>
            <button class="badge delete" title="Supprimer" *ngIf="!isEdgeDeleteDisabled(ctx.edge)" (click)="deleteEdge(ctx.edge)">
              <i class="fa-regular fa-circle-xmark"></i>
            </button>
          </div>
        </ng-template>
        <ng-template let-ctx nodeHtml>
          <div class="node-card" [attr.data-node-id]="ctx.node.id" [ngClass]="{ 'select-node': selection?.id === ctx.node.id, 'error-branch': isNodeInError(ctx.node.id) }" (click)="selectItem(ctx.node)" (contextmenu)="onNodeContextMenu($event, ctx.node)">
            <div class="header">
              <i [class]="ctx.node.data.model.templateObj?.icon" class="icon"></i>
              <div class="meta">
                <div class="title">{{ ctx.node.data.model.templateObj?.title || ctx.node.data.model?.name }}</div>
                <div class="subtitle">{{ ctx.node.data.model.templateObj?.subtitle }}</div>
              </div>
            </div>
            <ng-container *ngIf="inputId(ctx.node.data.model.templateObj) as inId">
              <ng-template #handleInTpl let-hctx>
                <svg:g>
                  <svg:circle
                    [attr.cx]="hctx.point().x"
                    [attr.cy]="hctx.point().y"
                    [attr.r]="hctx.state() === 'valid' ? 6 : 4"
                    [attr.fill]="isNodeInError(ctx.node.id) ? '#f759ab' : '#000000'"
                    [attr.stroke]="'#ffffff'"
                    stroke-width="1"
                  ></svg:circle>
                </svg:g>
              </ng-template>
              <handle position="top" type="target" [id]="inId" [template]="handleInTpl" />
            </ng-container>
            <div class="outputs" *ngIf="outputIds(ctx.node.data.model)?.length as outs">
              <div class="out" *ngFor="let out of outputIds(ctx.node.data.model); let i = index" [ngClass]="{ error: out === 'err' }">
                <ng-template #hTpl let-hctx>
                  <svg:g>
                    <svg:circle
                      [attr.cx]="hctx.point().x"
                      [attr.cy]="hctx.point().y"
                      [attr.r]="hctx.state() === 'valid' ? 6 : 4"
                      [attr.fill]="(out === 'err' || isNodeInError(ctx.node.id)) ? '#f759ab' : '#000000'"
                      [attr.stroke]="'#ffffff'"
                      stroke-width="1"
                      (mouseenter)="onHandleEnter($event, ctx.node.data.model, out)"
                      (mousemove)="onHandleMove($event)"
                      (mouseleave)="onHandleLeave()"
                    ></svg:circle>
                  </svg:g>
                </ng-template>
                <handle position="bottom" type="source" [id]="out" [template]="hTpl" />
              </div>
            </div>
          </div>
        </ng-template>
        <ng-template let-ctx connectionTemplate>
          <div class="edge-labels">
            <div class="badge label" [ngClass]="{ error: (computeEdgeLabel(ctx.connection?.source, ctx.connection?.sourceHandle) || '') === 'Error' }" *ngIf="computeEdgeLabel(ctx.connection?.source, ctx.connection?.sourceHandle) as txt">{{ txt }}</div>
          </div>
        </ng-template>
      </vflow>
      <!-- lightweight tooltip overlay -->
      <div class="flow-tooltip" *ngIf="tipVisible" [style.left.px]="tipX" [style.top.px]="tipY" [ngClass]="{ error: tipError }">{{ tipText }}</div>
    </div>
  </section>

  <aside class="inspector">
    <h4>Inspector</h4>
    <ng-container *ngIf="selectedNode; else noSel">
      <div class="tabs">
        <button [class.active]="inspectorTab==='settings'" (click)="inspectorTab='settings'">Settings</button>
        <button [class.active]="inspectorTab==='json'" (click)="inspectorTab='json'">JSON</button>
      </div>
      <div *ngIf="inspectorTab==='settings'">
        <div><strong>ID:</strong> {{ selectedModel?.id }}</div>
        <div><strong>Name:</strong> {{ selectedModel?.name }}</div>
        <div><strong>Type:</strong> {{ selectedModel?.templateObj?.type }}</div>
        <div><strong>Template:</strong> {{ selectedModel?.template }}</div>
        <div class="hint">Édition avancée disponible via l’onglet JSON.</div>
        <div class="inspector-actions">
          <button class="open-advanced" (click)="openAdvancedEditor()">Ouvrir l’éditeur avancé</button>
          <button class="danger" (click)="deleteSelected()" title="Supprimer">Supprimer</button>
        </div>
      </div>
      <div *ngIf="inspectorTab==='json'" class="json-box">
        <monaco-json-editor [(value)]="editJson" [height]="240"></monaco-json-editor>
        <div class="inspector-actions">
          <button class="save" (click)="saveSelectedJson()">Appliquer</button>
        </div>
      </div>
    </ng-container>
    <ng-template #noSel>
      <p>Sélectionnez un nœud.</p>
    </ng-template>
  </aside>
  <div class="import-overlay" *ngIf="isImporting">
    <div class="spinner"></div>
    <div>Import du flow…</div>
  </div>
  <div class="bottom-bar">
    <div class="actions">
      <button class="icon-btn" (click)="undo()" [disabled]="!canUndo" title="Annuler">
        <i class="fa-solid fa-rotate-left"></i>
      </button>
      <button class="icon-btn" (click)="redo()" [disabled]="!canRedo" title="Rétablir">
        <i class="fa-solid fa-rotate-right"></i>
      </button>
      <button class="icon-btn" (click)="centerFlow()" title="Centrer le flow">
        <i class="fa-regular fa-object-group"></i>
      </button>
      <button class="icon-btn" (click)="centerOnSelection()" [disabled]="!selectedNode" title="Centrer sur le nœud sélectionné">
        <i class="fa-solid fa-crosshairs"></i>
      </button>
      <button (click)="exportFlow()">Exporter le flow</button>
      <label class="import-btn">
        Importer un flow
        <input type="file" accept="application/json,.json" (change)="importFlow($event)" hidden>
      </label>
      <div class="zoom-control">
        <span class="label">Zoom</span>
        <input type="range" min="5" max="300" step="1" [ngModel]="zoomPercent" (ngModelChange)="onZoomSlider($event)" />
        <span class="value">{{ zoomPercent }}%</span>
      </div>
      <button class="icon-btn" (click)="saveFlow()" title="Sauvegarder">
        <i class="fa-regular fa-floppy-disk"></i>
      </button>
      <button class="icon-btn" (click)="runFlow()" title="Lancer">
        <i class="fa-solid fa-play"></i>
      </button>
      <span class="toast" *ngIf="toastMsg">{{ toastMsg }}</span>
    </div>
  </div>
  <!-- Context menu overlay -->
  <div class="ctx-overlay" *ngIf="ctxMenuVisible" (click)="closeCtxMenu()"></div>
  <div class="ctx-menu" *ngIf="ctxMenuVisible" [style.left.px]="ctxMenuX" [style.top.px]="ctxMenuY">
    <button (click)="ctxDuplicateTarget()"><i class="fa-regular fa-copy"></i> Dupliquer</button>
    <button (click)="ctxCenterTarget()"><i class="fa-solid fa-crosshairs"></i> Centrer sur ce nœud</button>
    <button (click)="ctxOpenAdvancedAndInspector()"><i class="fa-regular fa-pen-to-square"></i> Ouvrir l’éditeur + Inspector</button>
    <button class="danger" (click)="ctxDeleteTarget()"><i class="fa-regular fa-trash-can"></i> Supprimer</button>
  </div>
  <flow-advanced-editor-dialog *ngIf="advancedOpen && selectedModel"
    [model]="selectedModel"
    (modelChange)="onAdvancedModelChange($event)"
    (modelChangeCommitted)="onAdvancedModelCommitted($event)"
    (close)="closeAdvancedEditor()"></flow-advanced-editor-dialog>
</div>
