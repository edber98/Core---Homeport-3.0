<div class="builder-grid">
  <!-- PALETTE / CONTEXTE -->
  <div class="left">
    <nz-card nzTitle="Palette & Contexte" nzSize="small" class="card sticky">
      <div class="toolbar">
        <button nz-button nzSize="small" (click)="select(schema)">Form Settings</button>
        <button nz-button nzSize="small" (click)="addStep()" [disabled]="!canAddStep()">+ Step</button>
        <button nz-button nzSize="small" (click)="addSectionFromToolbar()" [disabled]="!canAddSectionBtn()">+ Section</button>
        <button nz-button nzSize="small" (click)="addFieldFromToolbar()" [disabled]="!canAddFieldBtn()">+ Field</button>
      </div>

      <nz-divider nzText="Structure"></nz-divider>
      <div class="tree">
        <nz-tree [nzData]="treeNodes" nzBlockNode (nzClick)="onTreeClick($event)" [nzSelectedKeys]="treeSelectedKeys" (nzExpandChange)="onTreeExpand($event)">
          <ng-template #nzTreeTemplate let-node>
            <!-- Root -->
            <span *ngIf="node.key==='root'; else notRoot"
                  (contextmenu)="openTreeMenu($event, menuRoot, node.key)"
                  class="tree-node-label">{{ node.title }}</span>
            <ng-template #notRoot>
            <!-- Step -->
            <span *ngIf="node.key.startsWith('step:') && node.key.indexOf(':field:') === -1 && !node.isLeaf; else notStep"
                  (contextmenu)="openTreeMenu($event, menuStep, node.key)"
                  class="tree-node-label">{{ node.title }}</span>
            <ng-template #notStep>
              <!-- Section -->
              <span *ngIf="node.key.indexOf(':field:')> -1 && !node.isLeaf; else leafField"
                    (contextmenu)="openTreeMenu($event, menuSection, node.key)"
                    class="tree-node-label">{{ node.title }}</span>
            </ng-template>
            <!-- Field -->
            <ng-template #leafField>
              <span (contextmenu)="openTreeMenu($event, menuField, node.key)"
                    class="tree-node-label">{{ node.title }}</span>
            </ng-template>
            </ng-template>
          </ng-template>
        </nz-tree>

        <!-- Menus contextuels -->
        <nz-dropdown-menu #menuStep="nzDropdownMenu">
          <ul nz-menu>
            <li nz-menu-item (click)="ctxAddSection()">+ Section</li>
            <li nz-menu-item (click)="ctxAddFieldToStep()">+ Field (étape)</li>
            <li nz-menu-item nzDanger (click)="ctxDeleteStep()">Supprimer l'étape</li>
          </ul>
        </nz-dropdown-menu>
        <nz-dropdown-menu #menuSection="nzDropdownMenu">
          <ul nz-menu>
            <li nz-menu-item (click)="ctxAddFieldToSection()">+ Field</li>
            <li nz-menu-item (click)="ctxAddFieldToSectionTyped('text')">+ Text</li>
            <li nz-menu-item (click)="ctxAddFieldToSectionTyped('textarea')">+ Textarea</li>
            <li nz-menu-item (click)="ctxAddFieldToSectionTyped('number')">+ Number</li>
            <li nz-menu-item (click)="ctxAddFieldToSectionTyped('date')">+ Date</li>
            <li nz-menu-item (click)="ctxAddFieldToSectionTyped('select')">+ Select</li>
            <li nz-menu-item (click)="ctxAddFieldToSectionTyped('radio')">+ Radio</li>
            <li nz-menu-item (click)="ctxAddFieldToSectionTyped('checkbox')">+ Checkbox</li>
            <li nz-menu-item (click)="ctxAddFieldToSectionTyped('textblock')">+ Textblock</li>
            <li nz-menu-item nzDanger (click)="ctxDeleteSection()">Supprimer</li>
          </ul>
        </nz-dropdown-menu>
        <nz-dropdown-menu #menuField="nzDropdownMenu">
          <ul nz-menu>
            <li nz-menu-item nzDanger (click)="ctxDeleteField()">Supprimer</li>
          </ul>
        </nz-dropdown-menu>
        <nz-dropdown-menu #menuRoot="nzDropdownMenu">
          <ul nz-menu>
            <li nz-menu-item (click)="ctxAddStep()">+ Step</li>
            <li nz-menu-item (click)="ctxAddSectionRoot()" [nzDisabled]="schema.steps?.length">+ Section (racine)</li>
            <li nz-menu-item (click)="ctxAddFieldRoot()" [nzDisabled]="schema.steps?.length">+ Field (racine)</li>
            <li nz-menu-divider></li>
            <li nz-menu-item (click)="ctxAddFieldRootTyped('text')" [nzDisabled]="schema.steps?.length">+ Text (racine)</li>
            <li nz-menu-item (click)="ctxAddFieldRootTyped('textarea')" [nzDisabled]="schema.steps?.length">+ Textarea (racine)</li>
            <li nz-menu-item (click)="ctxAddFieldRootTyped('number')" [nzDisabled]="schema.steps?.length">+ Number (racine)</li>
            <li nz-menu-item (click)="ctxAddFieldRootTyped('date')" [nzDisabled]="schema.steps?.length">+ Date (racine)</li>
            <li nz-menu-item (click)="ctxAddFieldRootTyped('select')" [nzDisabled]="schema.steps?.length">+ Select (racine)</li>
            <li nz-menu-item (click)="ctxAddFieldRootTyped('radio')" [nzDisabled]="schema.steps?.length">+ Radio (racine)</li>
            <li nz-menu-item (click)="ctxAddFieldRootTyped('checkbox')" [nzDisabled]="schema.steps?.length">+ Checkbox (racine)</li>
            <li nz-menu-item (click)="ctxAddFieldRootTyped('textblock')" [nzDisabled]="schema.steps?.length">+ Textblock (racine)</li>
          </ul>
        </nz-dropdown-menu>
      </div>

      <nz-divider nzText="Champs rapides"></nz-divider>
      <div class="palette">
        <button nz-button nzSize="small" (click)="quickAdd('text')">Text</button>
        <button nz-button nzSize="small" (click)="quickAdd('textarea')">Textarea</button>
        <button nz-button nzSize="small" (click)="quickAdd('number')">Number</button>
        <button nz-button nzSize="small" (click)="quickAdd('date')">Date</button>
        <button nz-button nzSize="small" (click)="quickAdd('select')">Select</button>
        <button nz-button nzSize="small" (click)="quickAdd('radio')">Radio</button>
        <button nz-button nzSize="small" (click)="quickAdd('checkbox')">Checkbox</button>
        <button nz-button nzSize="small" (click)="quickAdd('textblock')">TextBlock</button>
      </div>

      <nz-divider nzText="Grille"></nz-divider>
      <div class="context">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:6px;">
          <nz-select nzSize="small" [ngModelOptions]="{standalone:true}" [(ngModel)]="gridBp">
            <nz-option nzLabel="xs" nzValue="xs"></nz-option>
            <nz-option nzLabel="sm" nzValue="sm"></nz-option>
            <nz-option nzLabel="md" nzValue="md"></nz-option>
            <nz-option nzLabel="lg" nzValue="lg"></nz-option>
            <nz-option nzLabel="xl" nzValue="xl"></nz-option>
          </nz-select>
          <label nz-switch [ngModelOptions]="{standalone:true}" [(ngModel)]="showGrid">Afficher grille</label>
        </div>
      </div>

      <nz-divider nzText="Import / Export"></nz-divider>
      <div class="io">
        <textarea [(ngModel)]="json" [ngModelOptions]="{standalone: true}" placeholder="Colle ton JSON ici"></textarea>
        <div class="io-actions">
          <button nz-button nzSize="small" (click)="import()">Import</button>
          <button nz-button nzSize="small" (click)="export()">Export</button>
        </div>
      </div>
    </nz-card>

    <nz-card nzTitle="Prévisualisation responsive" nzSize="small" class="card sticky mt">
      <div class="bp">
        <label style="display:flex;align-items:center;gap:6px;margin-right:auto">
          <span>Mode édition</span>
          <nz-switch [(ngModel)]="editMode" [ngModelOptions]="{standalone:true}"></nz-switch>
        </label>
        <button nz-button nzSize="small" (click)="setPreviewWidth()">Auto</button>
        <button nz-button nzSize="small" (click)="setPreviewWidth(360)">XS</button>
        <button nz-button nzSize="small" (click)="setPreviewWidth(576)">SM</button>
        <button nz-button nzSize="small" (click)="setPreviewWidth(768)">MD</button>
        <button nz-button nzSize="small" (click)="setPreviewWidth(992)">LG</button>
        <button nz-button nzSize="small" (click)="setPreviewWidth(1200)">XL</button>
        <button nz-button nzSize="small" (click)="setPreviewWidth(1600)">XXL</button>
      </div>
    </nz-card>
  </div>

  <!-- CANVAS -->
  <div class="center">
    <nz-card nzTitle="Aperçu éditable" class="card fill">
      <app-dynamic-form
        [schema]="schema"
        [editMode]="editMode"
        [selectedField]="selectedField"
        [selectedSection]="selectedSectionForPreview"
        [selectedStep]="selectedStepForPreview"
        (editMoveField)="onEditMoveField($event)"
        (editDeleteField)="onEditDeleteField($event)"
        (editSelectField)="onEditSelectField($event)"
        (editSelectSection)="onEditSelectSection($event)"
        (editSelectStep)="onEditSelectStep($event)"
        (editAddFieldTyped)="onEditAddFieldTyped($event)"
        (editAddStep)="onEditAddStep()"
        (editAddSection)="onEditAddSection($event)"
        (editAddFieldStepRoot)="onEditAddFieldStepRoot($event)"
        (editAddFieldInSection)="onEditAddFieldInSection($event)"
      ></app-dynamic-form>
      <ng-container *ngIf="false">
      <!-- STEPPER -->
      <div class="steps"
           *ngIf="schema.steps"
           cdkDropList
           [cdkDropListData]="schema.steps || []"
           (cdkDropListDropped)="dropStep($event)">

        <div class="step"
             *ngFor="let step of schema.steps; let si=index"
             cdkDrag
             [class.selected]="isSelected(step)"
             (click)="select(step)">

          <div class="step-header" cdkDragHandle>
            <strong>{{ step.title || ('Step ' + (si+1)) }}</strong>
            <div class="actions">
              <button nz-button nzSize="small" (click)="addSection(step); $event.stopPropagation()">+ Section</button>
              <button nz-button nzSize="small" (click)="addFieldToStep(step); $event.stopPropagation()">+ Field (step)</button>
              <button nz-button nzSize="small" nzDanger (click)="removeStep(step); $event.stopPropagation()">Delete</button>
            </div>
          </div>

          <!-- Champs racine du step (sans section) -->
          <div class="fields grid" [class.show-grid]="showGrid"
               *ngIf="step.fields?.length"
               cdkDropList
               [cdkDropListData]="step.fields || []"
               (cdkDropListDropped)="dropFieldInStepRoot($event, step)">
            <div class="field"
                 *ngFor="let field of step.fields"
                 cdkDrag
                 [class.selected]="isSelected(field)"
                 (click)="select(field)">
              <span class="drag-handle" cdkDragHandle title="Déplacer">⋮⋮</span>
              <span class="f-label">{{ field.label || field.type }}</span>
              <span class="span-ctrls">
                <nz-tag nzColor="blue">{{ gridBp }}: {{ getSpan(field) }}</nz-tag>
                <button nz-button nzSize="small" (click)="changeSpan(field,-1); $event.stopPropagation()">-</button>
                <button nz-button nzSize="small" (click)="changeSpan(field,1); $event.stopPropagation()">+</button>
              </span>
              <span class="resize-handle" (mousedown)="onResizeStart($event, field)" title="Glisser pour redimensionner"></span>
              <button nz-button nzSize="small" nzDanger (click)="removeFieldFromStep(field, step); $event.stopPropagation()">Delete</button>
            </div>
          </div>

          <!-- Sections-in-fields are handled by the live preview; old step.sections block removed -->
        </div>
      </div>

      <!-- Root sections mode removed (use fields with type 'section') -->

      <!-- FLAT -->
      <div class="fields grid" [class.show-grid]="showGrid"
           *ngIf="schema.fields && !schema.steps"
           cdkDropList
           [cdkDropListData]="schema.fields || []"
           (cdkDropListDropped)="dropField($event)">
        <div class="field"
             *ngFor="let field of schema.fields"
             cdkDrag
             [class.selected]="isSelected(field)"
             (click)="select(field)">
          <span class="drag-handle" cdkDragHandle title="Déplacer">⋮⋮</span>
          <span class="f-label">{{ field.label || field.type }}</span>
          <span class="span-ctrls">
            <nz-tag nzColor="blue">{{ gridBp }}: {{ getSpan(field) }}</nz-tag>
            <button nz-button nzSize="small" (click)="changeSpan(field,-1); $event.stopPropagation()">-</button>
            <button nz-button nzSize="small" (click)="changeSpan(field,1); $event.stopPropagation()">+</button>
          </span>
          <span class="resize-handle" (mousedown)="onResizeStart($event, field)" title="Glisser pour redimensionner"></span>
          <button nz-button nzSize="small" nzDanger (click)="removeField(field); $event.stopPropagation()">Delete</button>
        </div>
      </div>
      </ng-container>
    </nz-card>
  </div>

  <!-- INSPECTOR -->
  <div class="right">
    <nz-card nzTitle="Inspector" class="card sticky" *ngIf="selected">
      <nz-tabs nzSize="small">
        <!-- PROPS OBJET -->
        <nz-tab nzTitle="Propriétés" *ngIf="selected !== schema">
          <form nz-form [formGroup]="inspector" class="inspector-form">
            <!-- STEP -->
            <ng-container *ngIf="isStep(selected)">
              <nz-form-item>
                <nz-form-label>Titre</nz-form-label>
                <nz-form-control><input nz-input formControlName="title"/></nz-form-control>
              </nz-form-item>
              <nz-form-item>
                <nz-form-label>visibleIf (JSON)</nz-form-label>
                <nz-form-control><textarea nz-input rows="3" formControlName="visibleIf"></textarea></nz-form-control>
              </nz-form-item>
            </ng-container>

            <!-- SECTION -->
            <ng-container *ngIf="isSection(selected)">
              <nz-form-item>
                <nz-form-label>Titre</nz-form-label>
                <nz-form-control><input nz-input formControlName="title"/></nz-form-control>
              </nz-form-item>
              <nz-form-item>
                <nz-form-label>Description</nz-form-label>
                <nz-form-control><textarea nz-input rows="3" formControlName="description"></textarea></nz-form-control>
              </nz-form-item>
              <nz-form-item>
                <nz-form-label>Grid gutter</nz-form-label>
                <nz-form-control><nz-input-number formControlName="gridGutter" [nzMin]="0"></nz-input-number></nz-form-control>
              </nz-form-item>
              <nz-form-item>
                <nz-form-label>visibleIf (JSON)</nz-form-label>
                <nz-form-control><textarea nz-input rows="3" formControlName="visibleIf" placeholder='{"==":[{"var":"country"},"FR"]}'></textarea></nz-form-control>
              </nz-form-item>
            </ng-container>

            <!-- FIELD -->
            <ng-container *ngIf="isField(selected)">
              <nz-form-item>
                <nz-form-label>Type</nz-form-label>
                <nz-form-control>
                  <nz-select formControlName="type">
                    <nz-option nzValue="text" nzLabel="text"></nz-option>
                    <nz-option nzValue="textarea" nzLabel="textarea"></nz-option>
                    <nz-option nzValue="number" nzLabel="number"></nz-option>
                    <nz-option nzValue="date" nzLabel="date"></nz-option>
                    <nz-option nzValue="select" nzLabel="select"></nz-option>
                    <nz-option nzValue="radio" nzLabel="radio"></nz-option>
                    <nz-option nzValue="checkbox" nzLabel="checkbox"></nz-option>
                    <nz-option nzValue="textblock" nzLabel="textblock"></nz-option>
                  </nz-select>
                </nz-form-control>
              </nz-form-item>

              <ng-container *ngIf="inspector.get('type')?.value !== 'textblock'">
                <nz-form-item>
                  <nz-form-label>Key</nz-form-label>
                  <nz-form-control><input nz-input formControlName="key"/></nz-form-control>
                </nz-form-item>
                <nz-form-item>
                  <nz-form-label>Label</nz-form-label>
                  <nz-form-control><input nz-input formControlName="label"/></nz-form-control>
                </nz-form-item>
                <nz-form-item>
                  <nz-form-label>Placeholder</nz-form-label>
                  <nz-form-control><input nz-input formControlName="placeholder"/></nz-form-control>
                </nz-form-item>
                <nz-form-item>
                  <nz-form-label>Description</nz-form-label>
                  <nz-form-control><textarea nz-input rows="2" formControlName="description"></textarea></nz-form-control>
                </nz-form-item>
                <nz-form-item>
                  <nz-form-label>Default</nz-form-label>
                  <nz-form-control><input nz-input formControlName="default"/></nz-form-control>
                </nz-form-item>
                <nz-form-item *ngIf="inspector.get('type')?.value==='select' || inspector.get('type')?.value==='radio'">
                  <nz-form-label>Options (JSON)</nz-form-label>
                  <nz-form-control><textarea nz-input rows="3" formControlName="options" placeholder='[{"label":"A","value":"a"}]'></textarea></nz-form-control>
                </nz-form-item>

                <nz-divider nzText="Conditions"></nz-divider>
                <nz-form-item>
                  <nz-form-label>visibleIf (JSON)</nz-form-label>
                  <nz-form-control><textarea nz-input rows="2" formControlName="visibleIf"></textarea></nz-form-control>
                </nz-form-item>
                <nz-form-item>
                  <nz-form-label>requiredIf (JSON)</nz-form-label>
                  <nz-form-control><textarea nz-input rows="2" formControlName="requiredIf"></textarea></nz-form-control>
                </nz-form-item>
                <nz-form-item>
                  <nz-form-label>disabledIf (JSON)</nz-form-label>
                  <nz-form-control><textarea nz-input rows="2" formControlName="disabledIf"></textarea></nz-form-control>
                </nz-form-item>

                <nz-form-item>
                  <nz-form-label>validators (JSON)</nz-form-label>
                  <nz-form-control><textarea nz-input rows="3" formControlName="validators" placeholder='[{"type":"required"},{"type":"min","value":0}]'></textarea></nz-form-control>
                </nz-form-item>

                <nz-form-item>
                  <nz-form-label>col (JSON)</nz-form-label>
                  <nz-form-control><textarea nz-input rows="2" formControlName="col" placeholder='{"xs":24,"md":12}'></textarea></nz-form-control>
                </nz-form-item>
              </ng-container>

              <ng-container *ngIf="inspector.get('type')?.value==='textblock'">
                <nz-form-item>
                  <nz-form-label>HTML</nz-form-label>
                  <nz-form-control><textarea nz-input rows="6" formControlName="textHtml"></textarea></nz-form-control>
                </nz-form-item>
                <nz-form-item>
                  <nz-form-label>col (JSON)</nz-form-label>
                  <nz-form-control><textarea nz-input rows="2" formControlName="col" placeholder='{"xs":24}'></textarea></nz-form-control>
                </nz-form-item>
              </ng-container>
            </ng-container>
          </form>
        </nz-tab>

        <!-- FORM SETTINGS (UI + SUMMARY) -->
        <nz-tab nzTitle="Form Settings" *ngIf="selected === schema">
          <form nz-form [formGroup]="inspector" class="inspector-form">
            <nz-form-item>
              <nz-form-label>Form Title</nz-form-label>
              <nz-form-control><input nz-input formControlName="title"/></nz-form-control>
            </nz-form-item>

            <nz-divider nzText="UI"></nz-divider>
            <nz-form-item>
              <nz-form-label>layout</nz-form-label>
              <nz-form-control>
                <nz-select formControlName="ui_layout">
                  <nz-option nzValue="horizontal" nzLabel="horizontal"></nz-option>
                  <nz-option nzValue="vertical" nzLabel="vertical"></nz-option>
                  <nz-option nzValue="inline" nzLabel="inline"></nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>

            <nz-form-item>
              <nz-form-label>labelAlign</nz-form-label>
              <nz-form-control>
                <nz-select formControlName="ui_labelAlign">
                  <nz-option nzValue="left" nzLabel="left"></nz-option>
                  <nz-option nzValue="right" nzLabel="right"></nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>

            <nz-form-item>
              <nz-form-label>labelCol.span / controlCol.span</nz-form-label>
              <nz-form-control class="inline-2">
                <nz-input-number formControlName="ui_labelColSpan" [nzMin]="0" [nzMax]="24" nzPlaceHolder="labelCol"></nz-input-number>
                <nz-input-number formControlName="ui_controlColSpan" [nzMin]="0" [nzMax]="24" nzPlaceHolder="controlCol"></nz-input-number>
              </nz-form-control>
            </nz-form-item>

            <nz-form-item>
              <nz-form-label>widthPx</nz-form-label>
              <nz-form-control><nz-input-number formControlName="ui_widthPx" [nzMin]="0"></nz-input-number></nz-form-control>
            </nz-form-item>

            <nz-divider nzText="Résumé"></nz-divider>
            <nz-form-item>
              <nz-form-label>enabled</nz-form-label>
              <nz-form-control><nz-switch formControlName="summary_enabled"></nz-switch></nz-form-control>
            </nz-form-item>
            <nz-form-item>
              <nz-form-label>title</nz-form-label>
              <nz-form-control><input nz-input formControlName="summary_title"/></nz-form-control>
            </nz-form-item>
            <nz-form-item>
              <nz-form-label>includeHidden</nz-form-label>
              <nz-form-control><nz-switch formControlName="summary_includeHidden"></nz-switch></nz-form-control>
            </nz-form-item>
            <nz-form-item>
              <nz-form-label>dateFormat</nz-form-label>
              <nz-form-control><input nz-input formControlName="summary_dateFormat" placeholder="dd/MM/yyyy"/></nz-form-control>
            </nz-form-item>
          </form>
        </nz-tab>

        <!-- APERCU JSON -->
        <nz-tab nzTitle="JSON">
          <pre class="json">{{ schema | json }}</pre>
        </nz-tab>
      </nz-tabs>
    </nz-card>
  </div>

  <!-- PREVIEW -->
  <div class="bottom">
    <nz-card class="card fill">
      <div class="preview-frame" [style.width.px]="previewWidth || null">
        <app-dynamic-form [schema]="schema"></app-dynamic-form>
      </div>
    </nz-card>
  </div>
</div>
