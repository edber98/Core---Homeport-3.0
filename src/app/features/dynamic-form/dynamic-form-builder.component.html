<div class="builder">
  <!-- PALETTE / CONTEXTE -->
  <div class="left">
    <df-context-panel
      [treeNodes]="treeNodes"
      [treeSelectedKeys]="treeSelectedKeys"
      [stepsMode]="isStepsMode"
      [canAddSectionBtn]="canAddSectionBtn()"
      [canAddFieldBtn]="canAddFieldBtn()"
      [canQuickAddField]="canQuickAddField"
      [json]="json"
      (selectFormSettings)="select(schema)"
      (addStep)="addStep()"
      (addSection)="addSectionFromToolbar()"
      (addSectionArray)="addArraySectionFromToolbar()"
      (addField)="addFieldFromToolbar()"
      (treeDrop)="onTreeDrop($event)"
      (treeClick)="onTreeSelect([$event])"
      (treeExpand)="onTreeExpand({ node: { key: $event.key }, isExpanded: $event.expanded })"
      (ctxAddStep)="ctxAddStep()"
      (ctxAddSectionRoot)="ctxAddSectionRoot()"
      (ctxAddSectionRootArray)="ctxAddSectionRootArray()"
      (ctxAddFieldRoot)="ctxAddFieldRoot()"
      (ctxAddFieldRootTyped)="ctxAddFieldRootTyped($event.type)"
      (ctxStepAddSection)="dropdownKey=$event.key; ctxAddSection()"
      (ctxStepAddSectionArray)="dropdownKey=$event.key; ctxAddSectionArray()"
      (ctxStepAddField)="dropdownKey=$event.key; ctxAddFieldToStep()"
      (ctxStepAddFieldTyped)="dropdownKey=$event.key; addFieldAtStepTyped($event.type)"
      (ctxStepDelete)="dropdownKey=$event.key; ctxDeleteStep()"
      (ctxSectionAddSection)="dropdownKey=$event.key; ctxAddSectionInside()"
      (ctxSectionAddSectionArray)="dropdownKey=$event.key; ctxAddSectionInsideArray()"
      (ctxSectionAddField)="dropdownKey=$event.key; ctxAddFieldToSection()"
      (ctxSectionAddFieldTyped)="dropdownKey=$event.key; ctxAddFieldToSectionTyped($event.type)"
      (ctxSectionDelete)="dropdownKey=$event.key; ctxDeleteSection()"
      (ctxSectionDuplicate)="dropdownKey=$event.key; ctxDuplicateSection()"
      (ctxSectionInsertBefore)="dropdownKey=$event.key; ctxInsertSectionBefore()"
      (ctxSectionInsertAfter)="dropdownKey=$event.key; ctxInsertSectionAfter()"
      (ctxFieldDelete)="dropdownKey=$event.key; ctxDeleteField()"
      (ctxFieldDuplicate)="dropdownKey=$event.key; ctxDuplicateField()"
      (ctxFieldInsertBefore)="dropdownKey=$event.key; ctxInsertFieldBefore()"
      (ctxFieldInsertAfter)="dropdownKey=$event.key; ctxInsertFieldAfter()"
      (quickAdd)="quickAdd($any($event))"
      (jsonChange)="json=$event"
      (doImport)="import()"
      (doExport)="export()"
    ></df-context-panel>

    <nz-card nzTitle="Prévisualisation responsive" nzSize="small" class="card sticky mt">
      <div class="bp">
        <label style="display:flex;align-items:center;gap:6px;margin-right:auto">
          <span>Mode édition</span>
          <nz-switch [(ngModel)]="editMode" (ngModelChange)="onEditModeChange($event)" [ngModelOptions]="{standalone:true}"></nz-switch>
        </label>
        <nz-tag nzColor="blue">BP: {{ forceBp || ('auto: ' + autoBp) }}</nz-tag>
        <button nz-button nzSize="small" (click)="setPreviewWidth()">Auto</button>
        <button nz-button nzSize="small" (click)="setPreviewWidth(360)">XS</button>
        <button nz-button nzSize="small" (click)="setPreviewWidth(576)">SM</button>
        <button nz-button nzSize="small" (click)="setPreviewWidth(768)">MD</button>
        <button nz-button nzSize="small" (click)="setPreviewWidth(992)">LG</button>
        <button nz-button nzSize="small" (click)="setPreviewWidth(1200)">XL</button>
        <button nz-button nzSize="small" (click)="setPreviewWidth(1600)">XXL</button>
      </div>
      <nz-divider nzText="Hypothèses de test"></nz-divider>
      <div style="max-height:180px; overflow:auto; display:flex; flex-direction:column; gap:6px;">
        <div *ngFor="let sc of scenarios" style="display:flex; align-items:center; gap:8px;">
          <span style="font-weight:600;">{{ sc.label }}</span>
          <span style="color:#64748b; font-size:12px;">{{ sc.description }}</span>
          <span style="flex:1"></span>
          <button nz-button nzSize="small" (click)="applyScenario(sc)">Appliquer</button>
        </div>
      </div>
      <nz-divider nzText="Cas du formulaire (variations)"></nz-divider>
      <div style="max-height:220px; overflow:auto; display:flex; flex-direction:column; gap:6px;">
        <div *ngFor="let sc of scenariosAll" style="display:flex; align-items:center; gap:8px;">
          <span style="font-weight:600;">{{ sc.label }}</span>
          <span style="color:#64748b; font-size:12px;">{{ sc.description }}</span>
          <span style="flex:1"></span>
          <button nz-button nzSize="small" (click)="applyScenarioAll(sc)">Remplir</button>
        </div>
      </div>
      <nz-divider nzText="Formulaire entier"></nz-divider>
      <div style="max-height:220px; overflow:auto; display:flex; flex-direction:column; gap:6px;">
        <div *ngFor="let sc of formScenarios" style="display:flex; align-items:center; gap:8px;">
          <span style="font-weight:600;">{{ sc.label }}</span>
          <span style="color:#64748b; font-size:12px;">{{ sc.description }}</span>
          <span style="flex:1"></span>
          <button nz-button nzSize="small" (click)="applyFormScenario(sc)">Remplir</button>
        </div>
      </div>
    </nz-card>

    <nz-card nzTitle="Conditions & Simulation" nzSize="small" class="card sticky mt">
      <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
        <label style="display:flex; align-items:center; gap:6px;">
          <span>Activer la simulation</span>
          <nz-switch [(ngModel)]="previewUseSim" [ngModelOptions]="{standalone:true}"></nz-switch>
        </label>
        <button nz-button nzSize="small" (click)="resetSimulation()">Réinitialiser</button>
      </div>
      <div style="max-height:220px; overflow:auto; display:flex; flex-direction:row; gap:6px;">
        <div *ngFor="let c of conditionEntries" style="border:1px solid #f0f0f0; border-radius:6px; padding:6px;">
          <div style="display:flex; align-items:center; gap:6px;">
            <nz-tag nzColor="blue">{{ c.kind }}</nz-tag>
            <strong style="flex:1;">{{ c.targetLabel }}</strong>
            <span style="color:#64748b; font-size:12px;" nz-tooltip [nzTooltipTitle]="describeRule(c.rule)">{{ describeRuleWithCtx(c) }}</span>
            <button nz-button nzSize="small" (click)="activateCondition(c)">{{ isRuleSatisfiedWithCtx(c) ? 'Désactiver' : 'Activer' }}</button>
          </div>
        </div>
      </div>
      <nz-divider nzText="Contrôles"></nz-divider>
      <div *ngIf="!issues.length" style="color:#64748b; font-size:12px;">Aucun problème détecté.</div>
      <ul *ngIf="issues.length" style="margin:0; padding-left:16px;">
        <li *ngFor="let it of issues" [style.color]="it.level==='blocker' ? '#b91c1c' : it.level==='error' ? '#dc2626' : '#b45309'" style="margin-bottom:6px;">
          <strong *ngIf="it.level==='blocker'">[Bloquant]</strong>
          <strong *ngIf="it.level==='error'">[Erreur]</strong>
          <strong *ngIf="it.level==='warning'">[Attention]</strong>
          <span> {{ it.message }} </span>
          <ng-container *ngIf="it.actions?.length">
            <button *ngFor="let a of it.actions" nz-button nzSize="small" style="margin-left:6px;" (click)="a.run()">{{ a.label }}</button>
          </ng-container>
        </li>
      </ul>
    </nz-card>

    <nz-card nzTitle="Contexte (ctx) pour expressions" nzSize="small" class="card sticky mt">
      <monaco-json-editor [value]="ctxJson" (valueChange)="onCtxChange($event)" [height]="180"></monaco-json-editor>
      <div style="color:#64748b; font-size:12px; margin-top:6px;">Ce JSON est passé à l'aperçu comme contexte des expressions (json/$json, env/$env, node/$node, now).</div>
    </nz-card>
  </div>

  <!-- CANVAS -->
  <div class="center">
    <nz-card nzTitle="Aperçu éditable" class="card fill">
      <div class="preview-frame" [style.width.px]="previewWidth || null">
      <app-dynamic-form
        [schema]="schema"
        [value]="previewUseSim ? simValues : undefined"
        [ctx]="ctxObj"
        [forceBp]="forceBp"
        [editMode]="editMode"
        [selectedField]="selectedField"
        [selectedSection]="selectedSectionForPreview"
        [selectedStep]="selectedStepForPreview"
        (editMoveField)="onEditMoveField($event)"
        (editDeleteField)="onEditDeleteField($event)"
        (editSelectField)="onEditSelectField($event)"
        (editSelectSection)="onEditSelectSection($event)"
        (editSelectStep)="onEditSelectStep($event)"
        (editMoveItem)="onEditMoveItem($event)"
        (editAddFieldTyped)="onEditAddFieldTyped($event)"
        (editAddStep)="onEditAddStep()"
        (editAddSection)="onEditAddSection($event)"
        (editAddFieldStepRoot)="onEditAddFieldStepRoot($event)"
        (editAddFieldInSection)="onEditAddFieldInSection($event)"
      ></app-dynamic-form>
      </div>

      <!-- Choix en cas de conflits de conditions sur un même champ -->
      <nz-modal [(nzVisible)]="conflictModalVisible" nzTitle="Choix de valeurs pour champs en conflit"
                (nzOnCancel)="cancelConflict()" (nzOnOk)="confirmConflict()">
        <ng-container *nzModalContent>
          <p>Plusieurs conditions proposent des valeurs différentes pour le même champ. Choisis la valeur à utiliser:</p>
          <div *ngFor="let it of conflictItems" style="display:flex; flex-direction:row; gap:6px; margin-bottom:10px;">
            <div style="display:flex; align-items:center; gap:8px;">
              <label style="min-width:160px; font-weight:600;">{{ it.key }}</label>
              <nz-select [(ngModel)]="it.selected" [ngModelOptions]="{standalone:true}" style="flex:1;" (ngModelChange)="onConflictSelectionChange()">
                <nz-option *ngFor="let ch of it.choices" [nzValue]="ch" [nzLabel]="displayChoiceLabel(it.key, ch)"></nz-option>
              </nz-select>
            </div>
            <div style="color:#64748b; font-size:12px;">
              Champs liés: {{ formatDependents(it.key) }}
            </div>
          </div>
          <div style="margin-top:6px; padding-top:6px; border-top:1px dashed #eee;">
            <div style="font-weight:600; margin-bottom:4px;">Impact prévisionnel</div>
            <ul style="margin:0; padding-left:18px;">
              <li *ngIf="conflictPreview.appear.length">Apparaissent: {{ conflictPreview.appear.join(', ') }}</li>
              <li *ngIf="conflictPreview.disappear.length">Disparaissent: {{ conflictPreview.disappear.join(', ') }}</li>
              <li *ngIf="conflictPreview.enable.length">Activés: {{ conflictPreview.enable.join(', ') }}</li>
              <li *ngIf="conflictPreview.disable.length">Désactivés: {{ conflictPreview.disable.join(', ') }}</li>
              <li *ngIf="conflictPreview.reqOn.length">Deviennent requis: {{ conflictPreview.reqOn.join(', ') }}</li>
              <li *ngIf="conflictPreview.reqOff.length">Ne sont plus requis: {{ conflictPreview.reqOff.join(', ') }}</li>
              <li *ngIf="!conflictPreview.appear.length && !conflictPreview.disappear.length && !conflictPreview.enable.length && !conflictPreview.disable.length && !conflictPreview.reqOn.length && !conflictPreview.reqOff.length" style="color:#64748b;">Aucun changement visible</li>
            </ul>
          </div>
        </ng-container>
      </nz-modal>
      <ng-container *ngIf="false">
      <!-- STEPPER -->
      <div class="steps"
           *ngIf="schema.steps"
           cdkDropList
           [cdkDropListData]="schema.steps || []"
           (cdkDropListDropped)="dropStep($event)">

        <div class="step"
             *ngFor="let step of schema.steps; let si=index"
             cdkDrag
             [class.selected]="isSelected(step)"
             (click)="select(step)">

          <div class="step-header" cdkDragHandle>
            <strong>{{ step.title || ('Step ' + (si+1)) }}</strong>
            <div class="actions">
              <button nz-button nzSize="small" (click)="addSection(step); $event.stopPropagation()">+ Section</button>
              <button nz-button nzSize="small" (click)="addFieldToStep(step); $event.stopPropagation()">+ Field (step)</button>
              <button nz-button nzSize="small" nzDanger (click)="removeStep(step); $event.stopPropagation()">Delete</button>
            </div>
          </div>

          <!-- Champs racine du step (sans section) -->
          <div class="fields grid" [class.show-grid]="showGrid"
               *ngIf="step.fields?.length"
               cdkDropList
               [cdkDropListData]="step.fields || []"
               (cdkDropListDropped)="dropFieldInStepRoot($event, step)">
            <div class="field"
                 *ngFor="let field of step.fields"
                 cdkDrag
                 [class.selected]="isSelected(field)"
                 (click)="select(field)">
              <span class="drag-handle" cdkDragHandle title="Déplacer">⋮⋮</span>
              <span class="f-label">{{ field.label || field.type }}</span>
              <span class="span-ctrls">
                <nz-tag nzColor="blue">{{ gridBp }}: {{ getSpan(field) }}</nz-tag>
                <button nz-button nzSize="small" (click)="changeSpan(field,-1); $event.stopPropagation()">-</button>
                <button nz-button nzSize="small" (click)="changeSpan(field,1); $event.stopPropagation()">+</button>
              </span>
              <span class="resize-handle" (mousedown)="onResizeStart($event, field)" title="Glisser pour redimensionner"></span>
              <button nz-button nzSize="small" nzDanger (click)="removeFieldFromStep(field, step); $event.stopPropagation()">Delete</button>
            </div>
          </div>

          <!-- Sections-in-fields are handled by the live preview; old step.sections block removed -->
        </div>
      </div>

      <!-- Root sections mode removed (use fields with type 'section') -->

      <!-- FLAT -->
      <div class="fields grid" [class.show-grid]="showGrid"
           *ngIf="schema.fields && !schema.steps"
           cdkDropList
           [cdkDropListData]="schema.fields || []"
           (cdkDropListDropped)="dropField($event)">
        <div class="field"
             *ngFor="let field of schema.fields"
             cdkDrag
             [class.selected]="isSelected(field)"
             (click)="select(field)">
          <span class="drag-handle" cdkDragHandle title="Déplacer">⋮⋮</span>
          <span class="f-label">{{ field.label || field.type }}</span>
          <span class="span-ctrls">
            <nz-tag nzColor="blue">{{ gridBp }}: {{ getSpan(field) }}</nz-tag>
            <button nz-button nzSize="small" (click)="changeSpan(field,-1); $event.stopPropagation()">-</button>
            <button nz-button nzSize="small" (click)="changeSpan(field,1); $event.stopPropagation()">+</button>
          </span>
          <span class="resize-handle" (mousedown)="onResizeStart($event, field)" title="Glisser pour redimensionner"></span>
          <button nz-button nzSize="small" nzDanger (click)="removeField(field); $event.stopPropagation()">Delete</button>
        </div>
      </div>
      </ng-container>
    </nz-card>
  </div>

  <!-- INSPECTOR -->
  <div class="right">
    <nz-card nzTitle="Inspector" class="card" *ngIf="selected">
      <nz-tabs nzSize="small">
        <!-- PROPS OBJET -->
        <nz-tab nzTitle="Propriétés" *ngIf="selected !== schema">
          <form nz-form [formGroup]="inspector" class="inspector-form" nzLayout="vertical">
            <!-- STEP -->
            <ng-container *ngIf="isStep(selected)">
              <inspector-step [group]="inspector"></inspector-step>
            </ng-container>

            <!-- SECTION -->
            <ng-container *ngIf="isSection(selected)">
              <inspector-section [group]="inspector" (openTitleStyle)="openTitleStyleEditor()" (openDescStyle)="openDescStyleEditor()" (openCondition)="openConditionBuilder('visibleIf')"></inspector-section>
            </ng-container>

            <!-- FIELD -->
            <ng-container *ngIf="isField(selected)">
              <inspector-field [group]="inspector" (openOptions)="openOptionsBuilder()" (openCondition)="openConditionBuilder($event)"></inspector-field>
            </ng-container>
          </form>
        </nz-tab>

        <!-- FORM SETTINGS (UI + SUMMARY) -->
        <nz-tab nzTitle="Form Settings" *ngIf="selected === schema">
          <inspector-form-settings [group]="inspector" [hasSections]="hasSections"></inspector-form-settings>
        </nz-tab>

        <!-- APERCU JSON -->
        <nz-tab nzTitle="JSON">
          <pre class="json">{{ schema | json }}</pre>
        </nz-tab>
      </nz-tabs>
    </nz-card>
  </div>

  <!-- PREVIEW du bas supprimé (aperçu central utilisé) -->
</div>

<!-- Modals -->
<nz-modal [(nzVisible)]="optionsModalVisible" nzTitle="Options" [nzWidth]="840" (nzOnCancel)="cancelOptions()" (nzOnOk)="saveOptions()">
  <ng-container *nzModalContent>
    <options-builder [group]="optionsForm" (add)="addOptionRow()" (remove)="removeOptionRow($event)"></options-builder>
  </ng-container>
</nz-modal>

<!-- Modals de style Titre/Description pour Section -->
<nz-modal [(nzVisible)]="titleStyleModalVisible" nzTitle="Style du Titre" [nzWidth]="720" (nzOnCancel)="cancelTitleStyle()" (nzOnOk)="saveTitleStyle()">
  <ng-container *nzModalContent>
    <form [formGroup]="titleStyleForm">
      <app-style-editor [group]="titleStyleForm"></app-style-editor>
    </form>
  </ng-container>
</nz-modal>

<nz-modal [(nzVisible)]="descStyleModalVisible" nzTitle="Style de la Description" [nzWidth]="720" (nzOnCancel)="cancelDescStyle()" (nzOnOk)="saveDescStyle()">
  <ng-container *nzModalContent>
    <form [formGroup]="descStyleForm">
      <app-style-editor [group]="descStyleForm"></app-style-editor>
    </form>
  </ng-container>
</nz-modal>

<nz-modal [(nzVisible)]="conditionModalVisible" nzTitle="Condition Builder" [nzWidth]="960" (nzOnCancel)="cancelCondition()" (nzOnOk)="saveCondition()">
  <ng-container *nzModalContent>
    <condition-builder [group]="conditionForm" [inputFieldKeys]="inputFieldKeys"
                      (addConditionRow)="addConditionRow()"
                      (addConditionGroup)="addConditionGroup()"
                      (removeConditionRow)="removeConditionRow($event)"
                      (changeCondKind)="changeCondKind($event.index, $event.kind)"
                      (addSubRule)="addSubRule($event)"
                      (addSubGroup)="addSubGroup($event)"
                      (removeSubAt)="removeSubAt($event.index, $event.subIndex)"></condition-builder>
  </ng-container>
</nz-modal>

<!-- Dialogue générique de personnalisation -->
<app-customize-dialog [title]="custTitle" [group]="custForm" [(visible)]="custVisible" (save)="saveCustomize()" (cancel)="cancelCustomize()"></app-customize-dialog>
