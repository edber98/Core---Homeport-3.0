<form [formGroup]="group" class="qb">
  <div class="qb-toolbar">
    <label>Logique</label>
    <nz-select formControlName="logic" style="min-width:160px;">
      <nz-option nzValue="single" nzLabel="single (1 règle)"></nz-option>
      <nz-option nzValue="any" nzLabel="any (OR)"></nz-option>
      <nz-option nzValue="all" nzLabel="all (AND)"></nz-option>
    </nz-select>
    <button nz-button nzType="dashed" (click)="addConditionRow.emit(); $event.preventDefault(); $event.stopPropagation()">+ Règle</button>
    <button nz-button nzType="dashed" (click)="addConditionGroup.emit(); $event.preventDefault(); $event.stopPropagation()">+ Groupe</button>
  </div>

  <div formArrayName="items" class="qb-items">
    <ng-container *ngFor="let grp of items.controls; let i=index">
      <div [formGroupName]="i" class="qb-item" [class.qb-item-group]="$any(grp).controls.kind.value==='group'" [class.qb-item-rule]="$any(grp).controls.kind.value==='rule'">
        <div class="qb-kind">
          <label>Type</label>
          <nz-select [ngModelOptions]="{standalone:true}" [(ngModel)]="$any(grp).controls.kind.value" (ngModelChange)="onChangeKind(i,$event)" style="width:120px;">
            <nz-option nzValue="rule" nzLabel="Règle"></nz-option>
            <nz-option nzValue="group" nzLabel="Groupe"></nz-option>
          </nz-select>
          <button nz-button nzType="text" nzDanger (click)="removeConditionRow.emit(i); $event.preventDefault(); $event.stopPropagation()">Supprimer</button>
        </div>

        <div *ngIf="$any(grp).controls.kind.value==='rule'" class="qb-rule">
          <nz-select formControlName="field" nzPlaceHolder="Champ">
            <nz-option *ngFor="let k of inputFieldKeys" [nzValue]="k" [nzLabel]="k"></nz-option>
          </nz-select>
          <nz-select formControlName="operator" class="op">
            <nz-option nzValue="==" nzLabel="=="></nz-option>
            <nz-option nzValue="!=" nzLabel="!="></nz-option>
            <nz-option nzValue=">" nzLabel=">"></nz-option>
            <nz-option nzValue=">=" nzLabel=">="></nz-option>
            <nz-option nzValue="<" nzLabel="<"></nz-option>
            <nz-option nzValue="<=" nzLabel="<="></nz-option>
          </nz-select>
          <input nz-input formControlName="value" placeholder="valeur" class="val"/>
        </div>

        <div *ngIf="$any(grp).controls.kind.value==='group'" class="qb-group">
          <div class="qb-group-head">
            <label>Logique</label>
            <nz-select formControlName="logic" style="min-width:160px;">
              <nz-option nzValue="any" nzLabel="any (OR)"></nz-option>
              <nz-option nzValue="all" nzLabel="all (AND)"></nz-option>
            </nz-select>
            <button nz-button nzType="dashed" (click)="addSubRule.emit(i); $event.preventDefault(); $event.stopPropagation()">+ Règle</button>
            <button nz-button nzType="dashed" (click)="addSubGroup.emit(i); $event.preventDefault(); $event.stopPropagation()">+ Groupe</button>
          </div>
          <div formArrayName="items" class="qb-subitems">
            <div *ngFor="let sub of subItemsAt(i).controls; let j=index" [formGroupName]="j" class="qb-item">
              <span class="qb-joiner" *ngIf="j>0">{{ $any(grp).controls.logic.value === 'any' ? 'OR' : 'AND' }}</span>
              <ng-container *ngIf="$any(sub).controls.kind?.value==='group'; else subRule">
                <div class="qb-group-head">
                  <label>Logique</label>
                  <nz-select formControlName="logic" style="min-width:140px;">
                    <nz-option nzValue="any" nzLabel="any (OR)"></nz-option>
                    <nz-option nzValue="all" nzLabel="all (AND)"></nz-option>
                  </nz-select>
                  <button nz-button nzType="text" nzDanger (click)="removeSubAt.emit({ index: i, subIndex: j }); $event.preventDefault(); $event.stopPropagation()">Supprimer</button>
                </div>
                <div formArrayName="items" class="qb-subitems">
                  <div *ngFor="let sub2 of subItemsAtNested(i,j).controls; let k=index" [formGroupName]="k" class="qb-item">
                    <span class="qb-joiner" *ngIf="k>0">{{ $any(sub).controls.logic.value === 'any' ? 'OR' : 'AND' }}</span>
                    <ng-container *ngIf="$any(sub2).controls.kind?.value==='group'; else nestedRule">
                      <span style="font-style:italic; color:#999;">Groupe imbriqué</span>
                    </ng-container>
                    <ng-template #nestedRule>
                      <div class="qb-rule">
                        <nz-select formControlName="field" nzPlaceHolder="Champ">
                          <nz-option *ngFor="let k of inputFieldKeys" [nzValue]="k" [nzLabel]="k"></nz-option>
                        </nz-select>
                        <nz-select formControlName="operator" class="op">
                          <nz-option nzValue="==" nzLabel="=="></nz-option>
                          <nz-option nzValue="!=" nzLabel="!="></nz-option>
                          <nz-option nzValue=">" nzLabel=">"></nz-option>
                          <nz-option nzValue=">=" nzLabel=">="></nz-option>
                          <nz-option nzValue="<" nzLabel="<"></nz-option>
                          <nz-option nzValue="<=" nzLabel="<="></nz-option>
                        </nz-select>
                        <input nz-input formControlName="value" placeholder="valeur" class="val"/>
                      </div>
                    </ng-template>
                  </div>
                </div>
              </ng-container>
              <ng-template #subRule>
                <div class="qb-rule">
                  <nz-select formControlName="field" nzPlaceHolder="Champ">
                    <nz-option *ngFor="let k of inputFieldKeys" [nzValue]="k" [nzLabel]="k"></nz-option>
                  </nz-select>
                  <nz-select formControlName="operator" class="op">
                    <nz-option nzValue="==" nzLabel="=="></nz-option>
                    <nz-option nzValue="!=" nzLabel="!="></nz-option>
                    <nz-option nzValue=">" nzLabel=">"></nz-option>
                    <nz-option nzValue=">=" nzLabel=">="></nz-option>
                    <nz-option nzValue="<" nzLabel="<"></nz-option>
                    <nz-option nzValue="<=" nzLabel="<="></nz-option>
                  </nz-select>
                  <input nz-input formControlName="value" placeholder="valeur" class="val"/>
                  <button nz-button nzType="text" nzDanger (click)="removeSubAt.emit({ index: i, subIndex: j }); $event.preventDefault(); $event.stopPropagation()">Supprimer</button>
                </div>
              </ng-template>
            </div>
          </div>
        </div>
      </div>
    </ng-container>
  </div>
</form>
