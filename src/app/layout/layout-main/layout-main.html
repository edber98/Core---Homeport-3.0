<!-- <div nz-flex [nzVertical]="false" class="full-height">

      <div class="padding-13">

            <div class="navbar">

                  <div class="item-navbar"  routerLink="/dashboard"   [routerLinkActiveOptions]="{ exact: true }" routerLinkActive="active-link" nz-flex [nzJustify]="'center'" [nzAlign]="'center'">
                        <nz-icon nzType="home" nzTheme="outline" />
                  </div>

                      <div class="item-navbar "  routerLink="/dashboard/stats"   [routerLinkActiveOptions]="{ exact: true }" routerLinkActive="active-link"  nz-flex [nzJustify]="'center'" [nzAlign]="'center'">
                        <nz-icon nzType="branches" nzTheme="outline" />
                  </div>

                  <div class="item-navbar" nz-flex [nzJustify]="'center'" [nzAlign]="'center'">
                        <nz-icon nzType="api" nzTheme="outline" />
                  </div>

                  <div class="item-navbar" nz-flex [nzJustify]="'center'" [nzAlign]="'center'">
                        <nz-icon nzType="appstore" nzTheme="outline" />
                  </div>

            </div>
      </div>
      <div class="full-width">

            <router-outlet></router-outlet>
      </div>
</div> -->

<nz-layout class="full-height">
  <!-- Sider (desktop) -->
  <nz-sider *ngIf="showSider" [nzCollapsible]="true" [(nzCollapsed)]="siderCollapsed" [nzCollapsedWidth]="80" [nzTheme]="'light'" class="border-right-primary" nzWidth="220px">
    <div class="logo" [class.collapsed]="siderCollapsed">
      <img src="/imgs/logo.png" alt="Kinn" />
      <span class="brand-text">Kinn</span>
    </div>
    <ul nz-menu nzTheme="light" style="border:0px !important" nzMode="inline">
      <ng-container *ngFor="let it of menu">
        <li nz-submenu *ngIf="it.children?.length && (!it.adminOnly || isAdmin)">
          <span title>
            <nz-icon [nzType]="it.icon"></nz-icon>
            <span>{{ it.label }}</span>
          </span>
          <ul>
            <li nz-menu-item *ngFor="let c of it.children" [routerLink]="c.route" routerLinkActive="ant-menu-item-selected" [routerLinkActiveOptions]="{ exact: true }">
              <nz-icon [nzType]="c.icon"></nz-icon>
              <span>{{ c.label }}</span>
            </li>
          </ul>
        </li>
        <li nz-menu-item *ngIf="!it.children?.length && (!it.adminOnly || isAdmin)" [routerLink]="it.route" routerLinkActive="ant-menu-item-selected" [routerLinkActiveOptions]="getActiveOptions(it.route)">
          <nz-icon [nzType]="it.icon"></nz-icon>
          <span>{{ it.label }}</span>
        </li>
      </ng-container>
    </ul>
  </nz-sider>

  <nz-layout>
    <!-- Header (also used on mobile) -->
    <nz-header class="hp-header border-bottom-primary">
      <div class="hdr-left" *ngIf="showSider || !showLaunch">
        <button nz-button nzType="default" class="burger" *ngIf="!showSider" (click)="openDrawer()"><i class="fa-solid fa-bars"></i></button>
        <div *ngIf="!showSider" class="brand">Kinn</div>
      </div>
      <div class="hdr-center" *ngIf="showSider || showLaunch">
        <div class="cmd-bar">
          <button class="cmd-btn pulse" nz-tooltip nzTooltipTitle="Lancer rapidement" (click)="runQuick()">
            <i class="fa-solid fa-rocket"></i>
          </button>
          <input nz-input class="cmd-search" placeholder="Rechercher… (flows, forms)" (keyup.enter)="onSearch($any($event.target).value)" />
          <button class="cmd-btn" nz-tooltip nzTooltipTitle="Commandes" (click)="openCmd()">
            <i class="fa-solid fa-sliders"></i>
          </button>
          <button class="cmd-btn" *ngIf="!showSider" (click)="closeLaunch()" nz-tooltip nzTooltipTitle="Fermer">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
      </div>
      <div class="hdr-actions" *ngIf="showSider || !showLaunch">
           <button nz-button class="hdr-btn" *ngIf="!showSider && !showLaunch" (click)="openLaunch()" title="Ouvrir la launch bar">
          <i class="fa-solid fa-rocket"></i>
        </button>
        <!-- User switcher -->
        <nz-select
          class="user-switcher"
          [ngModel]="selectedUserId"
          (ngModelChange)="onUserChange($event)"
          nzSize="small"
          nzShowSearch
          nzBorderless
          [nzDropdownMatchSelectWidth]="false"
          nzPlaceHolder="Utilisateur">
          <nz-option *ngFor="let u of acl.users()" [nzValue]="u.id" [nzLabel]="u.name"></nz-option>
        </nz-select>
        <!-- Workspace switcher (only accessible ones) -->
        <nz-select
          class="ws-switcher"
          [ngModel]="selectedWorkspaceId"
          (ngModelChange)="onWorkspaceChange($event)"
          nzSize="small"
          nzShowSearch
          nzBorderless
          [nzDropdownMatchSelectWidth]="false"
          [nzDisabled]="false"
          nzPlaceHolder="Workspace">
          <nz-option *ngFor="let w of accessibleWorkspaces" [nzValue]="w.id" [nzLabel]="w.name"></nz-option>
        </nz-select>
        <button nz-button class="hdr-btn" nz-popover [nzPopoverTrigger]="'click'" (click)="openNotificationsPopover()" [nzPopoverPlacement]="'bottomRight'" [nzPopoverOverlayClassName]="'hdr-popover'" [nzPopoverContent]="notifTpl" title="Notifications">
          <nz-badge [nzCount]="notifUnreadCount" [nzOverflowCount]="99" [nzShowZero]="false">
            <i class="fa-regular fa-bell"></i>
          </nz-badge>
        </button>
        <div class="hdr-avatar" nz-dropdown [nzDropdownMenu]="profileMenu" nzTrigger="click" title="Profil">
          <nz-avatar nzShape="circle" [nzText]="userInitials"></nz-avatar>
        </div>
      </div>
    </nz-header>

    <nz-content>
      <div class="inner-content">
        <router-outlet></router-outlet>
      </div>
    </nz-content>
  </nz-layout>

  <!-- Mobile drawer menu using the same menu[] source -->
  <nz-drawer [nzVisible]="drawerVisible" [nzBodyStyle]="{padding: '2px 2px 0 2px'}" (nzOnClose)="closeDrawer()" nzPlacement="left" [nzWidth]="260" [nzClosable]="false">

    <ng-container *nzDrawerContent>
      <div class="drawer-menu">
               <div class="logo">
      <img src="/imgs/logo.png" alt="Kinn" />
      <span class="brand-text">Kinn</span>
    </div>
        <div class="drawer-title">Navigation</div>
        <ul nz-menu nzTheme="light" nzMode="inline" style="border:0">
          <ng-container *ngFor="let it of menu">
            <li nz-submenu *ngIf="it.children?.length && (!it.adminOnly || isAdmin)">
              <span title>
                <nz-icon [nzType]="it.icon"></nz-icon>
                <span>{{ it.label }}</span>
              </span>
              <ul>
                <li nz-menu-item *ngFor="let c of it.children" (click)="go(c.route)">
                  <nz-icon [nzType]="c.icon"></nz-icon>
                  <span>{{ c.label }}</span>
                </li>
              </ul>
            </li>
            <li nz-menu-item *ngIf="!it.children?.length && (!it.adminOnly || isAdmin)" (click)="go(it.route)">
              <nz-icon [nzType]="it.icon"></nz-icon>
              <span>{{ it.label }}</span>
            </li>
          </ng-container>
        </ul>
      </div>
    </ng-container>
  </nz-drawer>
</nz-layout>

<!-- Command Center (modal) -->
<nz-modal  [(nzVisible)]="cmdVisible" [nzFooter]="null" nzTitle="Command Center" (nzOnCancel)="closeCmd()" [nzStyle]="isXs ? { top: '2px' } : undefined">
  <ng-container *nzModalContent>
  <div class="cmd-modal">
    <div class="section">
      <div class="section-title">Activité récente</div>
      <div class="activity" *ngFor="let a of activities">
        <span class="dot" [class.success]="a.state==='success'" [class.running]="a.state==='running'"></span>
        <div class="label">{{ a.label }}</div>
        <div class="time">{{ a.time }}</div>
      </div>
    </div>
    <div class="section grid">
      <div class="quick-card" (click)="runQuick()">
        <i class="fa-solid fa-rocket"></i>
        <div class="qc-title">Lancer</div>
        <div class="qc-desc">Exécution rapide</div>
      </div>
      <div class="quick-card" [routerLink]="'/flows'">
        <i class="fa-solid fa-diagram-project"></i>
        <div class="qc-title">Flows</div>
        <div class="qc-desc">Gérer vos scénarios</div>
      </div>
      <div class="quick-card" [routerLink]="'/forms'">
        <i class="fa-regular fa-rectangle-list"></i>
        <div class="qc-title">Formulaires</div>
        <div class="qc-desc">Construire / Voir</div>
      </div>
    </div>
    <div class="section two-cols">
      <div>
        <div class="section-title">Flows récents</div>
        <div class="chip" *ngFor="let f of recentFlows" [routerLink]="'/flows'">{{f.name}} <span class="muted">· {{f.updated}}</span></div>
      </div>
      <div>
        <div class="section-title">Formulaires récents</div>
        <div class="chip" *ngFor="let f of recentForms" [routerLink]="'/forms'">{{f.name}} <span class="muted">· {{f.updated}}</span></div>
      </div>
    </div>
  </div>
  </ng-container>
</nz-modal>

<!-- Notifications popover template -->
<ng-template #notifTpl>
  <div class="notif-panel">
    <div class="notif-header">Notifications</div>
    <div class="notif-list" *ngIf="!notifLoading; else notifLoadingTpl">
      <div class="notif-item" *ngFor="let n of notifications" [class.unread]="!n.acknowledged" (click)="openNotification(n)">
        <div class="meta">
          <div class="title">{{ n.title }}</div>
          <div class="desc">{{ n.desc }}</div>
        </div>
        <div class="actions">
          <button nz-button nzSize="small" class="mini" (click)="ackNotification(n); $event.stopPropagation()" [disabled]="n.acknowledged">Lu</button>
          <button nz-button nzSize="small" class="mini" (click)="deleteNotification(n); $event.stopPropagation()"><i class="fa-regular fa-trash-can"></i></button>
        </div>
      </div>
      <div class="empty" *ngIf="notifications.length===0">Aucune notification</div>
    </div>
    <ng-template #notifLoadingTpl>
      <div class="notif-loading">Chargement…</div>
    </ng-template>
    <div class="notif-footer"><a [routerLink]="'/flows'">Voir tout</a></div>
  </div>
  
</ng-template>

<!-- Profile dropdown menu -->
<nz-dropdown-menu #profileMenu="nzDropdownMenu">
  <ul nz-menu>
    <li nz-menu-item [routerLink]="'/dashboard'">Profil</li>
    <li nz-menu-item [routerLink]="'/forms'">Mes formulaires</li>
    <li nz-menu-item [routerLink]="'/flows'">Mes flows</li>
    <li nz-menu-item [routerLink]="'/change-password'">Changer le mot de passe</li>
    <li nz-menu-divider></li>
    <li nz-menu-item (click)="logout()">Déconnexion</li>
  </ul>
</nz-dropdown-menu>
